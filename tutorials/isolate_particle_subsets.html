
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Isolate particle subsets &#8212; tomoDRGN 0.2.3.dev328 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=d6c7774d"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/isolate_particle_subsets';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="External iterative processing" href="external_iterative_processing.html" />
    <link rel="prev" title="Visualize spatially-contextualized heterogeneity" href="visualize_spatially_contextualized_heterogeneity.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">tomoDRGN v0.2.3.dev328</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../overview/index.html">
    Overview
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../command_usage/index.html">
    Command Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">EMPIAR-10499 ribosomes</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="upstream_preprocessing.html">Upstream processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="validate_homogeneous_reconstruction.html">Validate particle extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="learn_structural_heterogeneity.html">Learn structural heterogeneity</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyze_structural_heterogeneity.html">Analyze structural heterogeneity</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize_spatially_contextualized_heterogeneity.html">Visualize spatially-contextualized heterogeneity</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Isolate particle subsets</a></li>
<li class="toctree-l1"><a class="reference internal" href="external_iterative_processing.html">External iterative processing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">U-M cryoET workshop 2024</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="um_cryoet_workshop_2024.html">Tutorial: U-M cryoET workshop 2024</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Tutorial: EMPIAR-10499 70S ribosomes</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Isolate particle subsets</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="isolate-particle-subsets">
<h1>Isolate particle subsets<a class="headerlink" href="#isolate-particle-subsets" title="Link to this heading">#</a></h1>
<section id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Link to this heading">#</a></h2>
<p>Once structural heterogeneity has been analyzed, we typically want to isolate homogeneous subpopulations of particles.
Subsequent 3-D reconstructions with <code class="docutils literal notranslate"><span class="pre">tomodrgn</span> <span class="pre">backproject_voxel</span></code> or in traditional STA tools can validate the tomoDRGN-observed structural state, while subsequent 3-D refinements can improve the reconstruction resolution both globally (particularly if using tomoDRGN to filter junk particles) and locally (in the local region of the annotated heterogeneity).</p>
</section>
<section id="filtering-a-star-file">
<h2>Filtering a star file<a class="headerlink" href="#filtering-a-star-file" title="Link to this heading">#</a></h2>
<p>TomoDRGN requires as input an “image series” star file, in which each particle is described by multiple related rows which each describe a single image of that particle.
However, many STA software require metadata in a “volume series” star file format, in which each particle is described by a single row (more analogous to SPA).
Therefore, we recommend that both types of star file are generated when extracting particles (as necessary for your STA software), and note that tomoDRGN supports filtering both types of star files by the same particle indices.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
Filtering with indices.pkl</label><div class="sd-tab-content docutils">
<p>Particle filtration is most often performed with an <code class="docutils literal notranslate"><span class="pre">indices.pkl</span></code> file which describes which particles should be retained for further analysis.
The <code class="docutils literal notranslate"><span class="pre">indices.pkl</span></code> file contains a numpy array of shape <code class="docutils literal notranslate"><span class="pre">(&lt;=</span> <span class="pre">num_particles)</span></code> of nonredundant integer-valued elements.
Each element represents a particle to be retained, in the order and indexing of the input star file used for tomoDRGN analysis.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">indices.pkl</span></code> file can be generated in several ways:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tomoDRGN_viz+filt_legacy.ipynb</span></code> jupyter notebook. This notebook contains extensive functionality to generate indices on the basis of desired clusters from latent space clustering, latent space outliers, interactive particle selection, and several additional approaches.</p></li>
<li><p>Outputs from MAVEn and SIREn can be used to identify which particles exhibit a structural feature of interest, perhaps defined as a specific occupancy pattern above a particular threshold.</p></li>
<li><p>A “quick and dirty” method based on selecting k-means classes of interest through a few lines of python is illustrated below, to skip much of the other functionality in the jupyter notebook</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tomodrgn</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="s1">&#39;analyze.49/kmeans100/labels.pkl&#39;</span><span class="p">)</span>  <span class="c1"># or use the volume space k-means labels at e.g. analyze.49/all_vols_analysis/kmeans100/voxel_kmeans100_labels.pkl</span>
<span class="n">kmeans_labels_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">])</span>  <span class="c1"># define your own labels here</span>
<span class="n">indices_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">kmeans_labels_to_keep</span><span class="p">])</span>
<span class="n">utils</span><span class="o">.</span><span class="n">save_pkl</span><span class="p">(</span><span class="n">indices_to_keep</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;analyze.49/kmeans100/indices_kept_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices_to_keep</span><span class="p">)</span><span class="si">}</span><span class="s1">-particles.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the indices file is generated, we can filter the image series and/or volume series star files with <code class="docutils literal notranslate"><span class="pre">tomodrgn</span> <span class="pre">filter_star</span></code>.
The full list of command line arguments can be found <a class="reference internal" href="../command_usage/filter_star.html"><span class="doc">here</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tomodrgn</span> <span class="n">filter_star</span> \
    <span class="n">imageseries</span><span class="o">.</span><span class="n">star</span> \
    <span class="o">--</span><span class="n">starfile</span><span class="o">-</span><span class="nb">type</span> <span class="n">imageseries</span> \
    <span class="o">--</span><span class="n">tomo</span><span class="o">-</span><span class="nb">id</span><span class="o">-</span><span class="n">col</span> <span class="n">_rlnImageName</span> \  <span class="c1"># useful when filtering the output star file for a particular tomogram&#39;s particles</span>
    <span class="o">--</span><span class="n">ind</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">indices</span><span class="o">.</span><span class="n">pkl</span> \
    <span class="o">-</span><span class="n">o</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imageseries_filtered</span><span class="o">.</span><span class="n">star</span>

<span class="n">tomodrgn</span> <span class="n">filter_star</span> \
    <span class="n">volumeseries</span><span class="o">.</span><span class="n">star</span> \
    <span class="o">--</span><span class="n">starfile</span><span class="o">-</span><span class="nb">type</span> <span class="n">volumeseries</span> \
    <span class="o">--</span><span class="n">tomo</span><span class="o">-</span><span class="nb">id</span><span class="o">-</span><span class="n">col</span> <span class="n">_rlnImageName</span> \
    <span class="o">--</span><span class="n">ind</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">indices</span><span class="o">.</span><span class="n">pkl</span> \
    <span class="o">-</span><span class="n">o</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imageseries_filtered</span><span class="o">.</span><span class="n">star</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
Filtering with labels.pkl</label><div class="sd-tab-content docutils">
<p>Particle filtration can also be performed with with a <code class="docutils literal notranslate"><span class="pre">labels.pkl</span></code> file which describes a single class label for each particle, coupled with a space-separated list of which class labels should be retained after filtering.
A frequently used source of the <code class="docutils literal notranslate"><span class="pre">labels.pkl</span></code> file is <code class="docutils literal notranslate"><span class="pre">tomodrgn</span> <span class="pre">analyze</span></code>, using the kmeans labels.</p>
<p>Once the set of desired class labels is known, we can filter the image series and/or volume series star files with <code class="docutils literal notranslate"><span class="pre">tomodrgn</span> <span class="pre">filter_star</span></code>.
The full list of command line arguments can be found <a class="reference internal" href="../command_usage/filter_star.html"><span class="doc">here</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tomodrgn</span> <span class="n">filter_star</span> \
    <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imageseries</span><span class="o">.</span><span class="n">star</span> \
    <span class="o">--</span><span class="n">starfile</span><span class="o">-</span><span class="nb">type</span> <span class="n">imageseries</span> \
    <span class="o">--</span><span class="n">tomo</span><span class="o">-</span><span class="nb">id</span><span class="o">-</span><span class="n">col</span> <span class="n">_rlnImageName</span> \
    <span class="o">--</span><span class="n">labels</span> <span class="mi">03</span><span class="n">_heterogeneity</span><span class="o">-</span><span class="mi">1</span><span class="n">_train_vae</span><span class="o">/</span><span class="n">analyze</span><span class="mf">.49</span><span class="o">/</span><span class="n">kmeans100</span><span class="o">/</span><span class="n">labels</span><span class="o">.</span><span class="n">pkl</span> \
    <span class="o">--</span><span class="n">labels</span><span class="o">-</span><span class="n">sel</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> \
    <span class="o">-</span><span class="n">o</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">imageseries_filtered</span><span class="o">.</span><span class="n">star</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpreting-outputs">
<h2>Interpreting outputs<a class="headerlink" href="#interpreting-outputs" title="Link to this heading">#</a></h2>
<p>The outputs are regular plain text .star files and may be viewed in any text editor or other package of choice.</p>
</section>
<section id="common-pitfalls">
<h2>Common pitfalls<a class="headerlink" href="#common-pitfalls" title="Link to this heading">#</a></h2>
<ul>
<li><p>If an <code class="docutils literal notranslate"><span class="pre">indices.pkl</span></code> is generated and then immediately used to train a new tomoDRGN model, the outputs of that model will not have indexing that can be directly aligned to the input star file (because a subset of particles from the input star file are being used for training / latent space embedding / etc.).</p>
<ul>
<li><p>This is handled in the background for you if generating particle indices using the jupyter notebook approach</p></li>
<li><p>If using a different approach, you will have to re-index your indices as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tomodrgn</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="c1"># generate your indices just as before</span>
<span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="s1">&#39;analyze.49/kmeans100/labels.pkl&#39;</span><span class="p">)</span>  <span class="c1"># or use the volume space k-means labels at e.g. analyze.49/all_vols_analysis/kmeans100/voxel_kmeans100_labels.pkl</span>
<span class="n">kmeans_labels_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">])</span>  <span class="c1"># define your own labels here</span>
<span class="n">indices_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">kmeans_labels_to_keep</span><span class="p">])</span>

<span class="c1"># NEW: re-index your selected indices to correspond to the unfiltered star file indexing</span>
<span class="n">prefiltered_indices</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="s1">&#39;path/to/indices/used/for/training.pkl&#39;</span><span class="p">)</span>
<span class="n">indices_to_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ind</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prefiltered_indices</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices_to_keep</span><span class="p">])</span>

<span class="c1"># save the indices.pkl file just as before</span>
<span class="n">utils</span><span class="o">.</span><span class="n">save_pkl</span><span class="p">(</span><span class="n">indices_to_keep</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;analyze.49/kmeans100/indices_kept_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices_to_keep</span><span class="p">)</span><span class="si">}</span><span class="s1">-particles.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>To avoid this problem, we recommend filtering the star file prior to to training a new tomoDRGN model, and not using the <code class="docutils literal notranslate"><span class="pre">--ind-ptcls</span></code> option of <code class="docutils literal notranslate"><span class="pre">tomodrgn</span> <span class="pre">train_vae</span></code></p></li>
</ul>
</li>
<li><p>Mapping particle indices derived from an imageseries star file (with tomoDRGN) to a volumeseries star file relies on the two star files describing the same set of particles in the same order. Usually particle extraction software adheres to this. However, the least error-prone way to ensure your star files are “in alignment” is to extract both image series and volume series subtomograms at the same time, rather than extracting volume series subtomograms only when needed for e.g. the current star file filtering.</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="visualize_spatially_contextualized_heterogeneity.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Visualize spatially-contextualized heterogeneity</p>
      </div>
    </a>
    <a class="right-next"
       href="external_iterative_processing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">External iterative processing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#purpose">Purpose</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-a-star-file">Filtering a star file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-outputs">Interpreting outputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pitfalls">Common pitfalls</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/tutorials/isolate_particle_subsets.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Barrett M Powell, Joseph H Davis.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>